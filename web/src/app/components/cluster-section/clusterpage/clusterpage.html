<div class="start-page-container">
    <div class="left-section">
        <mat-tab-group [selectedIndex]="selectedTabIndex()" (selectedIndexChange)="onTabChange($event)">
            <mat-tab label="Cluster">
            <app-cluster 
              (resultsReady)="onClusterResultsReady($event)">
            </app-cluster>
            </mat-tab>
            <mat-tab label="Diversity">
            <app-cluster-diversity 
              (showMetaplotModal)="openMetaplotModal($event)"
              (showKmerPlotModal)="openKmerPlotModal($event)"
              (resultsReady)="onDiversityResultsReady($event)">
            </app-cluster-diversity>
            </mat-tab>
            <mat-tab label="MAS">
            <app-cluster-msa></app-cluster-msa>
            </mat-tab>
            <mat-tab label="PHMM">
            <app-cluster-phmm></app-cluster-phmm>
            </mat-tab>
            <mat-tab label="Recluster">
               
            </mat-tab>
            <mat-tab label="Position Enrichment">
               
            </mat-tab>
        </mat-tab-group>
    </div>

    <div class="right-section" *ngIf="showResultsTable && tableData.length > 0">
        <div class="table-container">
            <div class="table-header">
                <label class="entries-label">
                    Show 
                    <select [(ngModel)]="pageSize" (change)="onPageSizeChange()" class="entries-select">
                        <option [value]="10">10</option>
                        <option [value]="25">25</option>
                        <option [value]="50">50</option>
                        <option [value]="100">100</option>
                    </select>
                    entries
                </label>
                <div class="search-box">
                    <label>Search: <input type="text" [(ngModel)]="searchText" (input)="onSearch()" class="search-input"></label>
                </div>
            </div>

            <div class="table-wrapper">
                <table mat-table [dataSource]="paginatedData" class="results-table" [ngClass]="getTableClass()">
                
                <!-- Sequence ID Column (for cluster results) -->
                <ng-container matColumnDef="sequenceID">
                    <th mat-header-cell *matHeaderCellDef>
                        Sequence ID
                        <input type="text" [(ngModel)]="columnFilters.sequenceID" (input)="applyColumnFilter()" class="column-filter" placeholder="All">
                    </th>
                    <td mat-cell *matCellDef="let row" class="id-cell">{{ row.sequenceID }}</td>
                </ng-container>

                <!-- Read Count Column (for cluster results) -->
                <ng-container matColumnDef="readCount">
                    <th mat-header-cell *matHeaderCellDef>
                        Read Count
                        <input type="text" [(ngModel)]="columnFilters.readCount" (input)="applyColumnFilter()" class="column-filter" placeholder="All">
                    </th>
                    <td mat-cell *matCellDef="let row">{{ row.readCount }}</td>
                </ng-container>

                <!-- Sequence Column (for cluster results) -->
                <ng-container matColumnDef="sequence">
                    <th mat-header-cell *matHeaderCellDef>
                        Sequence
                        <input type="text" [(ngModel)]="columnFilters.sequence" (input)="applyColumnFilter()" class="column-filter" placeholder="All">
                    </th>
                    <td mat-cell *matCellDef="let row" class="sequence-cell">{{ row.sequence }}</td>
                </ng-container>

                <!-- Cluster Column (shared by both cluster and diversity results) -->
                <ng-container matColumnDef="cluster">
                    <th mat-header-cell *matHeaderCellDef>
                        Cluster
                        <input type="text" [(ngModel)]="columnFilters.cluster" (input)="applyColumnFilter()" class="column-filter" placeholder="All">
                    </th>
                    <td mat-cell *matCellDef="let row">{{ row.cluster }}</td>
                </ng-container>

                <!-- Total Sequences Column -->
                <ng-container matColumnDef="totalSequences">
                    <th mat-header-cell *matHeaderCellDef>
                        Total Sequences
                        <input type="text" [(ngModel)]="columnFilters.totalSequences" (input)="applyColumnFilter()" class="column-filter" placeholder="All">
                    </th>
                    <td mat-cell *matCellDef="let row">{{ row.totalSequences }}</td>
                </ng-container>

                <!-- Total Reads Column -->
                <ng-container matColumnDef="totalReads">
                    <th mat-header-cell *matHeaderCellDef>
                        Total Reads
                        <input type="text" [(ngModel)]="columnFilters.totalReads" (input)="applyColumnFilter()" class="column-filter" placeholder="All">
                    </th>
                    <td mat-cell *matCellDef="let row">{{ row.totalReads }}</td>
                </ng-container>

                <!-- Total RPU Column -->
                <ng-container matColumnDef="totalRPU">
                    <th mat-header-cell *matHeaderCellDef>
                        Total RPU
                        <input type="text" [(ngModel)]="columnFilters.totalRPU" (input)="applyColumnFilter()" class="column-filter" placeholder="All">
                    </th>
                    <td mat-cell *matCellDef="let row">{{ row.totalRPU | number:'1.2-2' }}</td>
                </ng-container>

                <!-- Average LED Column -->
                <ng-container matColumnDef="averageLED">
                    <th mat-header-cell *matHeaderCellDef>
                        Average LED
                        <input type="text" [(ngModel)]="columnFilters.averageLED" (input)="applyColumnFilter()" class="column-filter" placeholder="All">
                    </th>
                    <td mat-cell *matCellDef="let row">{{ row.averageLED | number:'1.2-2' }}</td>
                </ng-container>

                <!-- SID Column -->
                <ng-container matColumnDef="SID">
                    <th mat-header-cell *matHeaderCellDef>
                        SID
                        <input type="text" [(ngModel)]="columnFilters.SID" (input)="applyColumnFilter()" class="column-filter" placeholder="All">
                    </th>
                    <td mat-cell *matCellDef="let row">{{ row.SID | number:'1.2-2' }}</td>
                </ng-container>

                <!-- Seed ID Column -->
                <ng-container matColumnDef="seedID">
                    <th mat-header-cell *matHeaderCellDef>
                        Seed ID
                        <input type="text" [(ngModel)]="columnFilters.seedID" (input)="applyColumnFilter()" class="column-filter" placeholder="All">
                    </th>
                    <td mat-cell *matCellDef="let row" class="id-cell">{{ row.seedID }}</td>
                </ng-container>

                <!-- Seed Sequence Column -->
                <ng-container matColumnDef="seedSequence">
                    <th mat-header-cell *matHeaderCellDef>
                        Seed Sequence
                        <input type="text" [(ngModel)]="columnFilters.seedSequence" (input)="applyColumnFilter()" class="column-filter" placeholder="All">
                    </th>
                    <td mat-cell *matCellDef="let row" class="sequence-cell">{{ row.seedSequence }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
            </div>

            <div class="table-footer">
                <div class="showing-info">
                    Showing {{ getShowingStart() }} to {{ getShowingEnd() }} of {{ filteredData.length }} entries
                </div>
                <div class="pagination">
                    <button (click)="previousPage()" [disabled]="currentPage === 1" class="pagination-button">Previous</button>
                    <button *ngFor="let page of getPageNumbers()" 
                            (click)="goToPage(page)" 
                            [class.active]="page === currentPage"
                            class="pagination-button page-number">
                        {{ page }}
                    </button>
                    <button (click)="nextPage()" [disabled]="currentPage === totalPages" class="pagination-button">Next</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cluster Metaplot Modal -->
@if (showMetaplotModalFlag) {
  <div class="modal-overlay" (click)="closeMetaplotModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ metaplotParams?.plot_title || 'Cluster Metaplots' }}</h2>
        <button mat-icon-button (click)="closeMetaplotModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <div id="metaplot-container" class="plot-container"></div>
      </div>
    </div>
  </div>
}

<!-- K-mer Plot Modal -->
@if (showKmerPlotModalFlag) {
  <div class="modal-overlay" (click)="closeKmerPlotModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ kmerPlotParams?.plot_title || 'K-mer Plot' }}</h2>
        <button mat-icon-button (click)="closeKmerPlotModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <div id="kmerplot-container" class="plot-container"></div>
      </div>
    </div>
  </div>
}
